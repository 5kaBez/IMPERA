generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Institute {
  id         Int         @id @default(autoincrement())
  name       String      @unique
  shortName  String?
  directions Direction[]
  createdAt  DateTime    @default(now())
}

model Direction {
  id          Int        @id @default(autoincrement())
  name        String
  instituteId Int
  institute   Institute  @relation(fields: [instituteId], references: [id], onDelete: Cascade)
  programs    Program[]
  createdAt   DateTime   @default(now())

  @@unique([name, instituteId])
}

model Program {
  id          Int        @id @default(autoincrement())
  name        String
  directionId Int
  direction   Direction  @relation(fields: [directionId], references: [id], onDelete: Cascade)
  groups      Group[]
  createdAt   DateTime   @default(now())

  @@unique([name, directionId])
}

model Group {
  id             Int      @id @default(autoincrement())
  name           String
  number         Int
  course         Int
  studyForm      String   @default("–û—á–Ω–∞—è")
  educationLevel String   @default("–ë–∞–∫–∞–ª–∞–≤—Ä–∏–∞—Ç")
  programId      Int
  program        Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
  lessons        Lesson[]
  users          User[]
  createdAt      DateTime @default(now())

  @@unique([number, programId, course, studyForm])
}

model Lesson {
  id         Int      @id @default(autoincrement())
  groupId    Int
  group      Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  dayOfWeek  Int      // 1=–ü–Ω, 2=–í—Ç, 3=–°—Ä, 4=–ß—Ç, 5=–ü—Ç, 6=–°–±
  pairNumber Int
  timeStart  String
  timeEnd    String
  parity     Int      // 0=—á—ë—Ç, 1=–Ω–µ—á—ë—Ç, 2=–æ–±–µ
  subject    String
  lessonType String   // –õ–µ–∫—Ü–∏—è, –ü—Ä–∞–∫—Ç–∏–∫–∞, –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è, –ü–ó
  teacher    String
  room       String
  weekStart  Int      @default(1)
  weekEnd    Int      @default(18)
  createdAt  DateTime @default(now())

  @@index([groupId, dayOfWeek])
  @@index([groupId, dayOfWeek, parity])
}

model User {
  id             Int        @id @default(autoincrement())
  telegramId     String     @unique
  firstName      String
  lastName       String?
  username       String?
  photoUrl       String?
  groupId        Int?
  group          Group?     @relation(fields: [groupId], references: [id])
  role           String     @default("student") // student, admin
  notifyBefore   Boolean    @default(true)
  notifyChanges  Boolean    @default(true)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  feedbacks       Feedback[]
  reviews         Review[]
  sportFavorites    SportFavorite[]
  sportTeaching     SportTeacher[]     // –°–µ–∫—Ü–∏–∏, –≥–¥–µ —é–∑–µ—Ä ‚Äî –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å —Ñ–∏–∑—Ä—ã
  sportSessions     SportSession[]     @relation("SessionTeacher")
  sportAttendances  SportAttendance[]  @relation("AttendanceStudent")
}

model Feedback {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   @default("suggestion") // suggestion, complaint, bug, other
  message   String
  status    String   @default("new") // new, read, resolved
  reply     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Teacher {
  id         Int      @id @default(autoincrement())
  name       String   @unique
  department String?
  photoUrl   String?
  reviews    Review[]
  createdAt  DateTime @default(now())
}

model Review {
  id        Int      @id @default(autoincrement())
  teacherId Int
  teacher   Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  rating    Int      // 1-5
  text      String?
  anonymous Boolean  @default(true)
  createdAt DateTime @default(now())

  @@index([teacherId])
  @@unique([teacherId, userId])
}

// ===== –§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞ =====
model SportSection {
  id        Int         @id @default(autoincrement())
  name      String      @unique // –ê—Ç–ª–µ—Ç–∏–∑–º, –ê—ç—Ä–æ–±–∏–∫–∞, –ë–∞—Å–∫–µ—Ç–±–æ–ª, etc.
  emoji     String?     // üèãÔ∏è, üíÉ, üèÄ, etc.
  slots     SportSlot[]
  favorites SportFavorite[]
  teachers  SportTeacher[]
  sessions  SportSession[]
  createdAt DateTime    @default(now())
}

model SportSlot {
  id         Int          @id @default(autoincrement())
  sectionId  Int
  section    SportSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  dayOfWeek  Int          // 1=–ü–Ω, 2=–í—Ç, 3=–°—Ä, 4=–ß—Ç, 5=–ü—Ç, 6=–°–±
  timeStart  String       // "09:00"
  timeEnd    String       // "10:30"
  teacher    String
  location   String?      // –°–ø–æ—Ä—Ç–∑–∞–ª, –ë–∞—Å—Å–µ–π–Ω, etc.
  capacity   Int?         // –ú–∞–∫—Å–∏–º—É–º —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  sessions   SportSession[]
  createdAt  DateTime     @default(now())

  @@index([sectionId, dayOfWeek])
  @@unique([sectionId, dayOfWeek, timeStart])
}

model SportFavorite {
  id        Int          @id @default(autoincrement())
  userId    Int
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  sectionId Int
  section   SportSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  createdAt DateTime     @default(now())

  @@unique([userId, sectionId])
}

// ===== –ê–Ω—Ç–∏—Ñ—Ä–æ–¥-—Å–∏—Å—Ç–µ–º–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π =====

// –°–≤—è–∑—å ¬´–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å —Ñ–∏–∑—Ä—ã ‚Üî —Å–µ–∫—Ü–∏—è¬ª (–æ–¥–∏–Ω —é–∑–µ—Ä –º–æ–∂–µ—Ç –≤–µ—Å—Ç–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—Ü–∏–π)
model SportTeacher {
  id        Int          @id @default(autoincrement())
  userId    Int
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  sectionId Int
  section   SportSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  createdAt DateTime     @default(now())

  @@unique([userId, sectionId])
}

// –°–µ—Å—Å–∏—è –∑–∞–Ω—è—Ç–∏—è ‚Äî –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å ¬´–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–∞—Ä—É¬ª
model SportSession {
  id          Int              @id @default(autoincrement())
  sectionId   Int
  section     SportSection     @relation(fields: [sectionId], references: [id])
  slotId      Int?
  slot        SportSlot?       @relation(fields: [slotId], references: [id])
  teacherId   Int
  teacher     User             @relation("SessionTeacher", fields: [teacherId], references: [id])
  status      String           @default("active") // active, completed, cancelled
  secretSeed  String           // –°–µ–∫—Ä–µ—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–æ—Ç–∏—Ä—É—é—â–∏—Ö –∫–æ–¥–æ–≤ (HMAC)
  startedAt   DateTime         @default(now())
  endedAt     DateTime?
  attendances SportAttendance[]

  @@index([status, startedAt])
  @@index([teacherId])
}

// –ü–æ—Å–µ—â–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞ —Å —Ö–µ—à-—Ü–µ–ø–æ—á–∫–æ–π (tamper-proof)
model SportAttendance {
  id          Int          @id @default(autoincrement())
  sessionId   Int
  session     SportSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  studentId   Int
  student     User         @relation("AttendanceStudent", fields: [studentId], references: [id])
  status      String       @default("pending") // pending ‚Üí confirmed / rejected
  checkedInAt DateTime     @default(now())
  confirmedAt DateTime?
  hash        String       // SHA256(studentId:sessionId:timestamp:prevHash)
  prevHash    String?      // –•–µ—à –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∑–∞–ø–∏—Å–∏ —ç—Ç–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞

  @@unique([sessionId, studentId]) // –û–¥–∏–Ω —Å—Ç—É–¥–µ–Ω—Ç ‚Äî –æ–¥–Ω–∞ –æ—Ç–º–µ—Ç–∫–∞ –∑–∞ —Å–µ—Å—Å–∏—é
  @@index([studentId, checkedInAt])
}
